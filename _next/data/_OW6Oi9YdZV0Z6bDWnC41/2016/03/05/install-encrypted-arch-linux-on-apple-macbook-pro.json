{"pageProps":{"post":{"slugs":{"year":"2016","month":"03","day":"05","slug":"install-encrypted-arch-linux-on-apple-macbook-pro"},"title":"Installing (encrypted) Arch Linux on an Apple MacBook Pro","displayTitle":"Installing (encrypted) Arch Linux on an Apple MacBook Pro","metaDescription":"A howto guide for installing encrypted Arch Linux on an Apple MacBook Pro with battery optimization and the Awesome window manager.","metaKeywords":"Apple, MacBook, MacBook Pro, encryption, linux, Arch Linux, GNU/Linux,","date":1457177700000,"author":"0xADADA","content":"<p>In the style of <a href=\"https://mchladek.me/post/arch-mbp/\">Michael Chladek</a>, I thought\nit would be useful to my future-self and others, if I wrote up a summary of\ninstalling Arch Linux on Apple MacBook hardware. Of course there are other\nguides out there, but this one is specific to the needs of someone looking for a\nminimalist, reproducible, secure, performance oriented installation of Arch\nLinux.</p>\n<p>In following this guide, I've made some decisions that are entirely based on my\nown (subjective) opinions. These opinions are based on my experiences with other\noperating systems and distros, and a number of window managers I've tried.</p>\n<p>My decisions (take them or leave them):</p>\n<ul>\n<li>Distribution: Arch Linux</li>\n<li>Full disk encryption: On</li>\n<li>Window Manager: Awesome</li>\n<li>Typography: infinality-bundle with the \"Free\" preset</li>\n</ul>\n<p>This article assumes you're currently running on a MacBook Pro between\ngeneration 7,1 (Mid-2010), 8,2 (Early-2011) or 11,3 (Late-2013). It assumes\nyou're running OS X and already have some experience with Linux commands, disk\npartitions and GNU/Linux. I've tested this guide on both of the above\ngenerations, but I'm assuming it'll work on anything in between. However, I make\nno guarantees.</p>\n<p>If you just want to get on to the installation, skip to this link:\n<a href=\"#installing-arch\">Installing Arch</a>.</p>\n<p><strong>Contents</strong>:</p>\n<ul>\n<li><a href=\"#background\">Background</a>\n<ul>\n<li><a href=\"#why-apple\">Why Apple?</a></li>\n<li><a href=\"#why-arch\">Why Arch?</a></li>\n<li><a href=\"#why-awesome\">Why Awesome?</a></li>\n</ul>\n</li>\n<li><a href=\"#preparing-to-install-arch\">Preparing to Install Arch</a>\n<ul>\n<li><a href=\"#getting-the-installation-media\">Getting the Installation Media</a></li>\n<li><a href=\"#preparing-the-installation-usb-drive\">Preparing the Installation USB Drive</a></li>\n</ul>\n</li>\n<li><a href=\"#installing-arch\">Installing Arch</a>\n<ul>\n<li><a href=\"#test-internet\">Test Internet</a> and\n<a href=\"#set-the-system-clock\">Set the System Clock</a></li>\n<li><a href=\"#partition-the-hard-drive\">Partition the Hard Drive</a></li>\n<li><a href=\"#configuring-drive-encryption-and-lvm\">Configuring Drive Encryption and LVM</a></li>\n<li><a href=\"#select-a-mirror\">Select a Mirror</a></li>\n<li><a href=\"#install-the-base-system\">Install the Base System</a></li>\n<li><a href=\"#generate-the-fstab\">Generate the fstab</a></li>\n<li><a href=\"#configure-the-system\">Configure The System</a></li>\n<li><a href=\"#boot-loader\">Boot Loader</a></li>\n<li><a href=\"#reboot-into-new-installation\">Reboot into New Installation</a></li>\n</ul>\n</li>\n<li><a href=\"#configuring-arch\">Configuring Arch</a>\n<ul>\n<li><a href=\"#install-an-arch-user-repository-package-manager\">Install an Arch User Repository Package Manager</a></li>\n<li><a href=\"#configure-sound\">Configure Sound</a></li>\n<li><a href=\"#install-x-and-video-drivers\">Install X and Video Drivers</a></li>\n<li><a href=\"#some-gui-applications\">Some GUI Applications</a></li>\n<li><a href=\"#improved-typography\">Improved Typography</a></li>\n<li><a href=\"#window-manager-awesome\">Window Manager Awesome</a></li>\n<li><a href=\"#touchpad-support\">Touchpad Support</a></li>\n<li><a href=\"#configuring-wireless\">Configuring Wireless</a></li>\n<li><a href=\"#done\">Done!</a></li>\n</ul>\n</li>\n<li><a href=\"#fine-tuning\">Fine Tuning</a>\n<ul>\n<li><a href=\"#display-color-profile\">Display Color Profile</a></li>\n<li><a href=\"#display-color-correction\">Display Color Correction</a></li>\n<li><a href=\"#power-management\">Power Management</a></li>\n<li><a href=\"#laptop-mode-tools\">Laptop Mode Tools</a></li>\n<li><a href=\"#acpid\">acpid</a></li>\n<li><a href=\"#cpu-frequency-scaling\">CPU Frequency Scaling</a></li>\n<li><a href=\"#temperature-management\">Temperature Management</a></li>\n<li><a href=\"#fan-control\">Fan Control</a></li>\n<li><a href=\"#apple-keyboard\">Apple Keyboard</a></li>\n<li><a href=\"#apple-trackpad\">Apple Trackpad</a></li>\n</ul>\n</li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n<li><a href=\"#references\">References</a></li>\n<li><a href=\"#footnotes\">Footnotes</a></li>\n</ul>\n<p>This article will be installing Arch Linux alongside OS X, dual-booting such\nthat you can easily boot into either. I recommend this, even if you’re not going\nto be using OS X at all, because right now (and likely for the foreseeable\nfuture) the only way to get firmware updates installed on your machine will be\nvia OS X. There have been Linux kernel–MacBook Pro firmware compatibility issues\nin the past that have been fixed by OS X updates that installed firmware fixes.</p>\n<p>I assume you have already repartitioned your drive giving you plenty of free\nspace for Arch. On my 500GB drive, I left 80GB for OS X (probably much more than\nreally necessary) and the rest I left free for Arch.</p>\n<p><strong>Conventions</strong></p>\n<p>For commands typed as the normal user, I will not prefix them:</p>\n<pre><code class=\"language-bash\">uname -a\n</code></pre>\n<p>For commands that need to be executed as a root account, i will prefix them with\na hash-mark: <code>#</code></p>\n<pre><code class=\"language-bash\"># uname -a\n</code></pre>\n<h2>Background</h2>\n<h3>Why Apple</h3>\n<p>I've been using OS X as my primary OS since 2011 when I bought my first Apple\nproduct, the 15\" MacBook Pro 8,2− which I still use today (March 2016, on which\nI'm writing this article). This alone is a testament to its' longevity as a\ncomputing platform. The industrial design of the hardware is a pleasure to the\neyes and is much imitated. The hardware feels wonderful to the touch. I've\ndisassembled a few of them, and despite the security screws, they're fairly easy\nto repair or upgrade. Only recently had I felt that its' age was starting to\nshow, so last week I doubled the ram from 8GB to 16GB and upgraded the hard\ndrive to a 512GB SSD. This should provide at least another two years of life for\nthis hardware.</p>\n<p>Recently however, Apple has changed their hardware design philosophy from a\nfairly open platform to a more proprietary and disposable one. They've\neliminated the ability to change or upgrade components. The\n<a href=\"https://en.wikipedia.org/wiki/MacBook_Pro#3rd_generation_.28Retina.29\">3rd generation MacBooks</a>\nhave a battery that is glued in place, the memory is soldered directly to the\nlogic board. Later models would come with the hard drive soldered down as well.</p>\n<p><a href=\"http://ifixit.org/blog/2763/the-new-macbook-pro-unfixable-unhackable-untenable/\">Lyle Wiens of iFixIt, said it best in 2012</a></p>\n<blockquote>\n<p>When Apple dropped the MacBook Air to $999 in 2010 to match the price point\nof the MacBook, they gave users a clear choice: the thin, light, and\nun-upgradeable MacBook Air or the heavier, longer lasting, [upgradable], more\nrugged, and more powerful MacBook. Same price, two very different products. At\nthe time, I wasn’t very happy with the non-upgradeable RAM on the MacBook Air,\nbut I respected that Apple had given their users a choice. It was up to us:\nDid we want a machine that would be stuck with 2GB of RAM forever? Would we\nsupport laptops that required replacement every year or two as applications\nrequired more memory and batteries atrophied?</p>\n<p>Consumers overwhelmingly voted yes, and the Air grew to take 40 percent of\nApple’s notebook sales by the end of 2010.</p>\n</blockquote>\n<p>This sort of vendor-lock down and\n<a href=\"https://en.wikipedia.org/wiki/Planned_obsolescence\">planned-obsolecence</a> has\nbothered me to such an extent that the next laptop I buy won't be Apple\nhardware.</p>\n<p>Meanwhile, Apple has secured an\n<a href=\"https://en.wikipedia.org/wiki/Oligopoly\">oligopoly</a> in the market, they have\nsuch a dominant position with hardware manufacturers that they seem to be\nsqueezing competitors out of getting access to top-quality components (or their\ncompetitors don't care about quality). These manufacturers seem to be building\ncomputers with \"Apples' scraps and leftovers\".</p>\n<p>Put simply; I don't see any manufacturers building laptops at the same level of\nquality that Apple does, and yet, I can't buy a\nproduct<sup><a href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref aria-describedby=\"footnote-label\">1</a></sup> that is so tightly\ncontrolled. Finally, I refuse to buy a product that is designed to be obsolete\nin two years.</p>\n<h3>Why Arch?</h3>\n<p>I first started using Linux in 1997 when I bought a\n<a href=\"https://upload.wikimedia.org/wikipedia/en/thumb/4/49/Redhat_5.2_box.jpg/220px-Redhat_5.2_box.jpg\">shrink-wrapped box of RedHat Linux 5.2</a>.\nAt the time, my internet connection was fast but not reliable enough to download\nthe ISO image over a 1-day dial-up session. Since then I've tried Slackware,\nSuSE, Mandrake, Debian, Fedora, Ubuntu, CentOS, and Mint. I customized the hell\nout of my distros, I performance tweaked, secured and customized the GUI. Back\nthen, information was hard to come by, the community was still small and poorly\ndocumented, and that hardly mattered when I couldn't access the internet because\nmy ethernet card drivers wouldn't compile.</p>\n<p><a href=\"https://medium.com/@fun_cuddles/linux-of-the-90s-or-why-i-have-linux-desktop-ptsd-1f276a7887fb#.jwg8up61m\">Jen Andre sums it up best</a></p>\n<blockquote>\n<p>You kids these days. You have it easy.</p>\n</blockquote>\n<p>It was enjoyable for a while, but I got very busy and eventually came to the\nconclusion that \"Linux is free if your time is worth nothing\" and stuck with OS\nX. I would occasionally install and try a different distro just to see if the\nOSS operating system world had changed, but that was about it.</p>\n<p>Arch is different however. Arch gets it, Arch gets it right. Arch is what I was\nsearching for all those years.</p>\n<ol>\n<li>A rolling release cycle keeps everything fresh</li>\n<li>I'm a huge advocate for their KISS Principal: Keep it Simple…</li>\n<li>The documentation is widely regarded as the best source of info on GNU/linux</li>\n<li>The Core package repository is very well maintained and trusted</li>\n<li>The User package repository is great at providing pretty much everything you\ncould need or want</li>\n<li>Its designed for people who want to understand and build a system from the\nground up. Install only what you know, only what you understand. It doesn't\nhide anything behind assumptions, scripts or fancy installers.</li>\n</ol>\n<blockquote>\n<p>Arch is like a sandbox, they provide the box and a source of sand (the Core\nand User package repos), but it's up to you to fill it and build your castle.</p>\n</blockquote>\n<h3>Why Awesome?</h3>\n<p>Like the topic of GNU/Linux distros, I could spend an entire post talking about\nwhy I settled on Awesome. I've tried GNOME, KDE, even Enlightenment. They all\nare trying to do more than I need, are too influenced by the design of the Big\nDesktop players and pander to novices at the expense of the power users.</p>\n<p>All I really need is a quick way to switch between windows and resize them as\nneeded and for it to be fast. The focus of the window manager is the application\ncontents, not the chrome eye-candy around the edges of the window.</p>\n<p>Awesome was designed for this.</p>\n<p>So, this guide is going to install Awesome as it's window manager. Feel free to\nswitch it out for whatever you prefer. i3, xmonad and DWM are all similar in\ndesign.</p>\n<h2>Preparing to Install Arch</h2>\n<p>When doing this article, I found many other articles very useful. They are\nlisted in <a href=\"#references\">References</a>. Please refer to them if needed. I will\nattempt to both update and condense these articles to a single \"Be-all End-all\nGuide\" to MacBook installation.</p>\n<h3>Getting the Installation Media</h3>\n<p>First, we need to get Arch Linux ISO from Arch Linux,\n<a href=\"https://www.archlinux.org/download/\">Go here to download it</a></p>\n<p>I usually go with the torrent option. It's the fastest.</p>\n<p>Next, we’re just going to make sure the download wasn’t corrupted or tampered\nwith in transit. To make this possible, the Arch Linux ISO publisher has posted\na cryptographic hash of the ISO. We can compare the hash of the ISO they\npublished against the hash of the ISO we downloaded. If the hash is identical,\nwe know the contents are exactly the same. Start the terminal and run the\nfollowing:</p>\n<pre><code class=\"language-bash\">sha1sum &#x3C;FILE>.iso\n</code></pre>\n<p>Next, we want to make sure the the ISO we've downloaded is provably supplied by\nthe Arch Linux team. We can do this by verifying the cryptographic signature\nthey provided with the ISO. The Arch team cryptographically signs their ISO\nimages using public-key cryptography. This ensures that the ISO file we've\ndownloaded is verifiably provided by the Arch Linux team, and not an impostor.</p>\n<p>This assumes you have GnuPG installed on your system (<code>brew install gnupg</code>). On\nthe ISO download page, there is a link under “Checksums” to get the PGP\nsignature as a <code>.sig</code> file. Download that into the same directory as your Arch\nISO. Then run the following, replacing the filename (here i use\n<code>archlinux-2016-02-01-dual.iso</code>) with the name of the files you've downloaded:</p>\n<pre><code class=\"language-bash\">gpg --verify \\\n    archlinux-2016.02.01-dual.iso.sig \\\n    archlinux-2016.02.01-dual.iso 2>&#x26;1 | \\\n    grep 'key ID' | \\\n    gpg --recv-keys 2>&#x26;1 `awk '{print $NF}'` &#x26;&#x26; \\\ngpg --verify archlinux-2016.02.01-dual.iso.sig \\\n    archlinux-2016.02.01-dual.iso 2>&#x26;1 | grep 'signature from'\n</code></pre>\n<p>This will first attempt to verify the signature, and if you don't have the\nsigners key, it'll retrieve it. It'll then try to verify it again, and should\nprint out \"Good signature\" if it succeeds. If you get \"Bad signature\" this means\nthe ISO has either been forged by an impostor pretending to be the Arch linux\nteam, or someone has tampered with the ISO stored on their servers or in\ntransit. If thats the case, you need to find an alternate source to download the\nISO.</p>\n<h3>Preparing the Installation USB Drive</h3>\n<p>This installation method will first create a bootable USB stick, which is used\nto boot into a \"Live\" Arch Linux session. From there, we use the Live Arch Linux\nto install Arch onto your MacBook hard drive, then make that partition bootable.</p>\n<p>If you're currently running a GNU/Linux system, follow the instructions in\n<a href=\"#part-a---preparing-the-installation-usb-drive-for-linux\">Part A</a>. If you're\nrunning OS X,\n<a href=\"#part-b---preparing-the-installation-usb-drive-for-osx\">jump one section ahead to Part B</a>.</p>\n<h4>Part A - Preparing the Installation USB Drive for Linux</h4>\n<p>If you're already on a GNU/Linux system, use these instructions to create USB\nbootable Arch Linux live system.</p>\n<p>Now we’re ready to get that ISO onto a USB drive so we can boot the computer\nfrom it. Before inserting the thumb drive, run <code>lsblk</code> and take note of the\ndrives listed. Insert the drive and run <code>lsblk</code> again. Take note of the new\nletter in the <code>sdX</code> list of drives.</p>\n<p>Replace the <code>X</code> with the letter on your system. Be sure to unmount the new\ndrive.</p>\n<pre><code class=\"language-bash\">umount /dev/sdX\n</code></pre>\n<p>Next, run the following command, it reads the ISO file you downloaded earlier\nand writes the contents directly to the USB drive, without the operating system\nbuffering the writes. Replace the <code>X</code> with the letter of the USB stick you took\nnote of earlier, and <code>ARCHLINUX</code> with the name of the image file you downloaded.</p>\n<pre><code class=\"language-bash\">dd if=ARCHLINUX.iso of=/dev/sdX bs=4M\n</code></pre>\n<p>After that’s run, the USB drive should be ready to boot from.</p>\n<h4>Part B - Preparing the Installation USB Drive for OSX</h4>\n<p>Now we’re ready to get that ISO onto a USB drive so we can boot the computer\nfrom it. Before inserting the thumb drive, run <code>diskutil list</code> and take note of\nthe drives listed. You should see output similar to this:</p>\n<pre><code>/dev/disk0\n   #:                       TYPE NAME          SIZE       IDENTIFIER\n   0:      GUID_partition_scheme               500.1 GB   disk0\n   1:                        EFI               209.7 MB   disk0s1\n   2:          Apple_CoreStorage               399.5 GB   disk0s2\n   3:                 Apple_Boot Recovery HD   650.0 MB   disk0s3\n   5:                 Apple_Boot Boot OS X     134.2 MB   disk0s5\n/dev/disk1\n   #:                       TYPE NAME          SIZE       IDENTIFIER\n   0:                  Apple_HFS MacOSX        399.2 GB   disk1\n</code></pre>\n<p>Insert the drive and run <code>diskutil list</code> again. Take note of the new letter in\nthe <code>sdX</code> list of drives.</p>\n<pre><code>/dev/disk0\n   #:                       TYPE NAME          SIZE       IDENTIFIER\n   0:      GUID_partition_scheme               500.1 GB   disk0\n   1:                        EFI               209.7 MB   disk0s1\n   2:          Apple_CoreStorage               399.5 GB   disk0s2\n   3:                 Apple_Boot Recovery HD   650.0 MB   disk0s3\n   5:                 Apple_Boot Boot OS X     134.2 MB   disk0s5\n/dev/disk1\n   #:                       TYPE NAME          SIZE       IDENTIFIER\n   0:                  Apple_HFS MacOSX        399.2 GB   disk1\n/dev/diskX\n   #:                       TYPE NAME          SIZE       IDENTIFIER\n   0:      GUID_partition_scheme               2.0 GB     disk2\n   1:       Microsoft Basic Data UNTITLED 1    2.0 GB     disk2s1\n</code></pre>\n<p>Note <code>/dev/diskX</code> has appeared ('X' will be a number on your system), this new\ndisk is the USB thumb drive. <strong>Important</strong> <em>take note of the number of this\ndrive</em>.</p>\n<p>We're going to remove the existing partitions and erase all the data so its\nclean for our Arch Linux installer. This will delete all the data on the USB\ndrive. Make sure to substitute <code>/dev/diskX</code> for the drive number you noted\nabove.</p>\n<pre><code class=\"language-bash\">diskutil partitionDisk /dev/diskX 1 \"Free Space\" \"unused\" \"100%\"\n</code></pre>\n<p>Now<sup><a href=\"#user-content-fn-4\" id=\"user-content-fnref-4\" data-footnote-ref aria-describedby=\"footnote-label\">2</a></sup> we can write the iso\nfile to the USB drive. <strong>Note</strong> We use <code>/dev/rdisk*</code> instead of <code>/dev/disk</code>\nbecause it provides Raw disk access without the typical buffering the operating\nsystemprovides. Substitute <code>DESTINATION</code> with the name of the <code>iso</code> file you\ndownloaded earlier, and substitute the <code>X</code> with the number of the drive.</p>\n<pre><code class=\"language-bash\">dd if=DESTINATION.iso of=/dev/rdiskX bs=1m\n</code></pre>\n<p>The <code>dd</code> command does not show any output before it has finished the copy\nprocess, so be patient and wait for it to complete, it can take around 1 - 5\nminutes. When the command does complete OS X will try to mount the drive and\nfail as it won't recognize the formatting. Click ignore.</p>\n<h2>Installing Arch</h2>\n<p>With the USB drive plugged in, restart the MacBook and press+hold down the left\n<code>option/alt</code> key when you hear the startup chime. Hold the <code>option</code> key down\nuntil the drive screen appears.</p>\n<p>The USB drive should be one of the options. Pick it along with the first option\nthe following boot screen lists. Now you should be at the Arch live install\nprompt and it'll look like this:</p>\n<pre><code>Arch Linux 3.17.6-1-ARCH (tty1)\n\narchiso login: root (automatic login)\nroot@archiso ~ #\n</code></pre>\n<p>You are now running a \"Live\" session of Arch Linux from the USB stick.</p>\n<p>If you're on a HiDPI / \"Retina\" display MacBook, the prompt is really small.\nIncrease the font-size using <code>setfont sun12x22</code>.</p>\n<h3>Test Internet</h3>\n<p>You'll need a working Internet connection to do the post-install. My MacBook Pro\n7,1 and 8,2 both have Ethernet ports, but some of you will have later models\nwithout one. You should get a USB-Ethernet adapter. Its much easier than\nfiddling with wireless drivers as it works out of the box. We'll setup the\nwireless drivers later in this article.</p>\n<p>First, we need to get an IP address from your router:</p>\n<pre><code class=\"language-bash\">dhcpcd\n</code></pre>\n<p>With the adapter plugged in and an IP address, make sure internet is flowing by\npinging Google:</p>\n<pre><code class=\"language-bash\">ping -c 3 www.google.com\n</code></pre>\n<p>You should get a response that all three packets were sent and received.</p>\n<h3>Set the System Clock</h3>\n<p>The system clock should be just fine. The general Arch wiki recommends ensuring\nthe system clock is accurate, and I’ve found it doesn’t seem to break anything.\nSo, I run it:</p>\n<pre><code class=\"language-bash\">timedatectl set-ntp true\n</code></pre>\n<h3>Partition the Hard Drive</h3>\n<p>A partition is basically a box on the hard drive to put files into. OS X has a\nbox for its files, and we're going to create box(es) for GNU/Linux. Partitioning\nthe hard drive takes existing data on the drive and moves or erases it to make\nspace available for other file systems.</p>\n<p>This part is the trickiest because it can erase data on the disk, so take care.</p>\n<p>Apple uses the GUID Partition Table (GPT), and we're going to keep that\npartition table.</p>\n<p>In order to proceed you'll need to know the drive mapping scheme, we'll use\n<code>fdisk</code> to check the scheme:</p>\n<pre><code class=\"language-bash\">fdisk -l\n</code></pre>\n<p>This lists the existing partitions. If you created two partitions when preparing\nthe MacBook, you should see a partition with a Type of <code>Apple HFS/HFS+</code> with a\nsize that matches the size you set aside for Arch. In my case this was\n<code>/dev/sda5</code>. All the partitioning commands below will use <code>/dev/sda5</code>, <strong>you\nshould substitute the designation for your drive</strong>.</p>\n<p>Lets use <code>cgdisk</code> to view the partition table on the attached devices: Replace\nthe <code>Y</code> with the drive you'll be using to install Arch Linux.</p>\n<pre><code class=\"language-bash\">cgdisk /dev/sdY\n</code></pre>\n<p>At the end of the partition table should be the free space you set aside for\ninstalling Arch. With that space, we're going to create a new partition. You\njust need to make one partition; we’re going to break it into sub-partitions\nlater; after encryption is setup.</p>\n<p>I added 128MB between the last partition and my new partition\n<a href=\"https://developer.apple.com/library/mac/technotes/tn2166/_index.html\">because of this explanation by Apple</a>.</p>\n<blockquote>\n<p>Note: We leave free space after each partition to make it easier for future\nsystem software to manipulate the partition map in ways that we can’t\nanticipate currently.</p>\n</blockquote>\n<p>Begin by deleting the <code>HFS</code> partition created when you set aside space in OS X\nfor Arch Linux.</p>\n<p>In order to leave additional space, just type <code>+128M</code> when you create the new\npartition, and it'll set the starting sector at a point 128M away from the\nending sector of the partition before it.</p>\n<p>You’ll want to use Linux LVM (<code>8e00</code>) as the partition type id. The final\npartition table will look something like this:</p>\n<pre><code>Part. #     Size        Partition Type            Partition Name\n----------------------------------------------------------------\n3.0 KiB      free space\n1        200.0 MiB      EFI System                EFI System Partition\n2         74.5 GiB      Apple HFS/HFS+            Macintosh HD\n128.0 MiB      free space\n3        391.1 GiB      Linux LVM                 ArchLinux\n</code></pre>\n<p>Then use the utility to select Write and then confirm that you want to overwrite\nthe disk. Once the display returns you can Quit.</p>\n<p>Running <code>fdisk -l</code> again should show your new partition scheme. If it doesn't\nlook like you want or expected, repeat the <code>cgdisk</code> process to fix things until\nyou're satisfied.</p>\n<h3>Configuring Drive Encryption and LVM</h3>\n<p>You’ll want to make note of the partition number you just created. For me it’s\npartition <code>5</code>, and the drive is <code>sda</code>, so my Arch Linux partition can be found\nat <code>/dev/sda5</code>. I'll be using that as an example going forward, <strong>but you should\nsubstitute your own drive path</strong>.</p>\n<p>We’re going to encrypt <code>/dev/sda5</code> using DM-Crypt and then the LVM partitions\nare going to be created over that LUKS encryption layer. This system is called\n\"LVM on LUKS.\" Both LUKS encryption and LVM support are provided by the\nGNU/Linux kernel.</p>\n<p><strong>Note</strong> This will just encrypt the system <code>/</code> and <code>/home</code> directories. The\n<code>/boot</code> directory will not be encrypted because we’re going to keep the existing\n<code>/boot</code> partition: That’s <code>/dev/sda1</code> in my partition table above.</p>\n<p>If you want to use custom ciphers, there are some great notes\n<a href=\"https://github.com/NoviceLive/unish/blob/master/doc/arch-install.sh#L101\">available on GitHub</a>.\nYou can also use the following command for speed benchmarking to help determine\nwhich ciphers and key-sizes are fast enough for your particular use case:</p>\n<pre><code class=\"language-bash\">cryptsetup benchmark\n</code></pre>\n<p>Time to pick the encryption flavors! The default values for the cipher and key\nsizes were a bit too light for my tastes (in light of the NSA spying scandal).\nI've increased these numbers above the defaults, I've chosen to balance my\nprincipals for privacy and security with practical usability and speed. Feel\nfree to\n<a href=\"https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Encryption_options_for_LUKS_mode\">read more on these settings</a>.</p>\n<pre><code class=\"language-bash\">cryptsetup --cipher aes-xts-plain64 \\\n  --key-size 512 \\\n  --hash sha256 \\\n  --iter-time 3000 \\\n  --use-random \\\n  --verify-passphrase \\\n  luksFormat /dev/sda5\n</code></pre>\n<p>Enter in a good passphrase (twice), and we should be good to go.</p>\n<p>Now with the encryption setup, we’re going to create the necessary volumes and\nfilesystems within the LVM.</p>\n<p>First, let’s open up our encrypted partition:</p>\n<pre><code class=\"language-bash\">cryptsetup luksOpen /dev/sda5 lvm\n</code></pre>\n<p>This is going to map our encrypted device (<code>/dev/sda5</code> in my case) to\n<code>/dev/mapper/lvm</code>. Now we’re going to create the physical and logical volumes\nfor the <code>/</code> and <code>/home</code> directories. I gave the <code>/</code> directory 40GB (hopefully\nenough for all my programs. As of writing this, and with a full install, I’m\nusing 10GB on my <code>/</code> directory. So, I think I’m good.</p>\n<p>Create the physical volume:</p>\n<pre><code class=\"language-bash\">pvcreate /dev/mapper/lvm\n</code></pre>\n<p>Now create the volume with the name <code>vgcrypt</code>:</p>\n<pre><code class=\"language-bash\">vgcreate vgcrypt /dev/mapper/lvm\n</code></pre>\n<p>We're ready to create the logical volumes now, <code>40GB</code> for root and the rest for\nusers’ home, change <code>40GB</code> accordingly:</p>\n<pre><code class=\"language-bash\">lvcreate --size 40G --name root vgcrypt\nlvcreate --extents +100%FREE --name home vgcrypt\n</code></pre>\n<p>We now have our two volumes <code>vgcrypt-root</code> and <code>vgcrypt-home</code>. They need to be\nformatted to a particular filesystem. I’ve been happy with the <code>ext4</code>\nfilesystem.</p>\n<pre><code class=\"language-bash\">mkfs.ext4 /dev/mapper/vgcrypt-root\nmkfs.ext4 /dev/mapper/vgcrypt-home\n</code></pre>\n<p>We can now mount these new partitions. Make sure to mount the root partition\nfirst so we can create the <code>/home</code> directory inside of it for the home\npartition:</p>\n<pre><code class=\"language-bash\">mount /dev/mapper/vgcrypt-root /mnt\nmkdir -p /mnt/home\nmount /dev/mapper/vgcrypt-home /mnt/home\n</code></pre>\n<p>Lets also mount our boot partition, while we're here. This is required so our\nbootable initramfs can be written to the boot drive:</p>\n<pre><code class=\"language-bash\">mkdir -p /mnt/boot\nmount /dev/sda1 /mnt/boot\n</code></pre>\n<p>If you're interested in swap partition schemes,\n<a href=\"https://github.com/NoviceLive/unish/blob/master/doc/arch-install.sh#L127\">check this script out</a>\n− although I'm fine without swap partitions (Its faster with enough RAM).</p>\n<p>And with that, Arch is now ready to be installed on the disk.</p>\n<h3>Select a Mirror</h3>\n<p>This step can optionally be skipped, but I prefer to choose a US server just in\ncase it may be faster. Open up the mirrorlist:</p>\n<pre><code class=\"language-bash\">vi /etc/pacman.d/mirrorlist\n</code></pre>\n<p>Delete or comment out all the servers except one or two near you that seem good.</p>\n<h3>Install the Base System</h3>\n<p>Actually installing Arch Linux onto the drive is the easiest part:</p>\n<pre><code class=\"language-bash\">pacstrap -i /mnt base base-devel terminus-font\n</code></pre>\n<p>The <code>-i</code> flag asks for confirmation before installing packages. I like using it\njust so I can see what’s being installed. (After all that's part of the reason\nfor using GNU/Linux, right? To know what’s being installed on your system.)</p>\n<p>This installation includes <code>terminus-font</code>, which we'll configure to be the\ndefault console font later on.</p>\n<h3>Generate the fstab</h3>\n<p>If all went according to plan, Arch has been written to the hard drive and is\nnow installed. Before rebooting into our installation, though, we need to tell\nthe system where to find the filesystems we created earlier for root and home\ndirectories.</p>\n<p>While it’s normally a good idea to use UUIDs to find disks, we’re going to use\nlabels. This is because our encryption setup generates random IDs for the disks\nwhen they’re decrypted. Let’s create the <code>fstab</code> file:</p>\n<pre><code class=\"language-bash\">genfstab -L -p /mnt >> /mnt/etc/fstab\n</code></pre>\n<p>The <code>-L</code> flag will generate the fstab file with labels instead of UUIDs. The\n<code>-p</code> flag prevents pseudo-filesystems from being added.</p>\n<p>Always check the generated fstab:</p>\n<pre><code class=\"language-bash\">cat /mnt/etc/fstab\n</code></pre>\n<p>It should look something like this:</p>\n<pre><code>#\n# /etc/fstab: static file system information\n#\n# &#x3C;file system>    &#x3C;dir>&#x3C;type>&#x3C;options>             &#x3C;dump>&#x3C;pass>\n# /dev/mapper/vgcrypt-root\n/dev/mapper/vgcrypt-root    /           ext4   discard,rw,relatime,data=ordered    0 1\n\n# /dev/mapper/vgcrypt-home\n/dev/mapper/vgcrypt-home    /home       ext4   discard,rw,relatime,data=ordered    0 2\n</code></pre>\n<p><strong>Note</strong> If your hard drive is a solid-state drive (SSD) and the <code>discard</code>\noption isn’t there, edit the fstab file and add it. It's used for optimizing for\nthe speed of SSDs.</p>\n<h3>Configure The System</h3>\n<p>We’re now ready to configure our new system. Let’s change root into it:</p>\n<pre><code class=\"language-bash\">arch-chroot /mnt /bin/bash\n</code></pre>\n<p>Set our system locale. I'm in the US, so I'll only uncomment that locale from\n<code>/etc/locale.gen</code>:</p>\n<pre><code>...\nen_US.UTF-8 UTF-8\nen_US ISO-8859-1\n...\n</code></pre>\n<p>Now generate the locales:</p>\n<pre><code class=\"language-bash\">locale-gen\n</code></pre>\n<p>Make English UTF-8 the default:</p>\n<pre><code class=\"language-bash\">echo LANG=en_US.UTF-8 > /etc/locale.conf\n</code></pre>\n<p>The default font in the virtual console is not very readable, so lets use one\nthat is far more readable. We're going to use the typeface \"Terminus\" in size 18\nthat we installed with the base system earlier. <code>ter-118n</code> basically means\n\"Terminus latin-1 size 18 Normal\". There are other sizes available: 12, 14, 16,\n20, 22, 24, 28, 32 as well as support for multiple non-English code pages.</p>\n<pre><code class=\"language-bash\">echo FONT=ter-118n > /etc/vconsole.conf\n</code></pre>\n<p>Set the timezone accordingly. (I live on the east coast):</p>\n<pre><code class=\"language-bash\">ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime\n</code></pre>\n<p>And set the time to the standard UTC:</p>\n<pre><code class=\"language-bash\">hwclock --systohc --utc\n</code></pre>\n<p>Because we've encrypted our root disk, we need to make sure the kernel loads the\nproper modules to decrypt it on startup. Otherwise we won’t be able to boot from\nthe unencrypted drive. We're also going to tell the boot-sequence to load our\ncustom font and keyboard module so we can type our passwords during boot. Edit\n<code>/etc/mkinitcpio.conf</code> and add the hooks <code>consolefont keyboard encrypt lvm2</code>\n<strong>BEFORE</strong> <code>filesystems</code> so the HOOKS line looks like this:</p>\n<pre><code>HOOKS=\"base udev autodetect modconf block consolefont keyboard usbinput encrypt lvm2 filesystems fsck\"\n</code></pre>\n<p>Now we need to regenerate the initramfs image:</p>\n<pre><code class=\"language-bash\">mkinitcpio -p linux\n</code></pre>\n<p>So that Internet will work on reboot, we need to enable the <code>dhcpcd</code> service.\nWe’re going to keep using the ethernet-USB adapter for right now. We'll get\nwireless setup later. Get the name of the ethernet interface:</p>\n<pre><code class=\"language-bash\">ip link\n</code></pre>\n<p>It should be <code>enp</code>-something. With that, enable the service, make sure you\nreplace INTERFACE with your interfaces name.</p>\n<pre><code class=\"language-bash\">systemctl enable dhcpcd@INTERFACE.service\n</code></pre>\n<p>Finally, let’s configure the machine’s hostname. You can change <code>macbook</code> to\nwhatever you'd like:</p>\n<pre><code class=\"language-bash\">echo macbook > /etc/hostname\n</code></pre>\n<p>Add this hostname to the list of hosts. Edit <code>/etc/hosts</code> and edit so it looks\nsomething like this:</p>\n<pre><code>#\n# /etc/hosts: static lookup table for host names\n#\n\n#&#x3C;ip-address>   &#x3C;hostname.domain.org>   &#x3C;hostname>\n127.0.0.1   localhost.localdomain   localhost   macbook\n::1     localhost.localdomain   localhost   macbook\n</code></pre>\n<p>Set a root password:</p>\n<pre><code class=\"language-bash\">passwd\n</code></pre>\n<p>Create a non-root user for yourself and set the user’s password, replace USER\nwith the username of your choosing:</p>\n<pre><code class=\"language-bash\">useradd --create-home --groups wheel --shell /bin/bash USER\npasswd USER\n</code></pre>\n<p>This will create the user, add it to the group wheel (traditional group of users\nwho can run <code>sudo</code> commands), create a home directory under <code>/home/USER/</code> and\nmake his default shell <code>bash</code> then set a default password for the user.</p>\n<p>Don't switch to the new user yet, because we'e added USER to the group <code>wheel</code>,\nlets grant the wheel group <code>sudo</code> privileges. Run:</p>\n<pre><code class=\"language-bash\">visudo\n</code></pre>\n<p>And uncomment the following line so it looks like so:</p>\n<pre><code>%wheel ALL=(ALL) ALL\n</code></pre>\n<h3>Boot Loader</h3>\n<p>Now we need to let the boot loader know where to find our new Arch Linux\ninstallation. <code>systemd</code> (was recently renamed, was Gummiboot) is a nice, simple\nboot loader.</p>\n<pre><code class=\"language-bash\"># pacman -S systemd              # May be systemd-boot, included in core?\nmkdir -p /boot/loader/entries\n</code></pre>\n<p>Setup the loader to default to arch and set the number of seconds to timeout in\nthe file <code>/boot/loader/loader.conf</code>:</p>\n<pre><code class=\"language-bash\">default arch\ntimeout 3\n</code></pre>\n<p>Make sure the correct boot partition (<code>/dev/sda1</code> in my case) is mounted on\n<code>/boot</code> by running:</p>\n<pre><code>findmnt /boot\n-------------------------\nTARGET SOURCE    FSTYPE OPTIONS\n/boot  /dev/sda1 vfat   rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,err\n</code></pre>\n<p>Now we’re going to create an entry called <code>/boot/loader/entries/arch.conf</code> that\nlooks like this:</p>\n<pre><code># /boot/loader/entries/arch.conf\ntitle   Arch Linux\nlinux   /vmlinuz-linux\ninitrd  /initramfs-linux.img\noptions cryptdevice=/dev/sdaX:vgcrypt:allow-discards root=/dev/mapper/vgcrypt-root rw\n</code></pre>\n<p><strong>Note</strong>:<sup><a href=\"#user-content-fn-7\" id=\"user-content-fnref-7\" data-footnote-ref aria-describedby=\"footnote-label\">3</a></sup> On the options\nline, make sure you replace <code>/dev/sdaX</code> with the path to the encrypted linux\npartition we previously created on your device (It was <code>/dev/sda5</code> in this\nguide). Additionally, if your drive is <em>not</em> a SSD, make sure to remove\n<code>:allow-discards</code>.</p>\n<p><strong>Note</strong>:<sup><a href=\"#user-content-fn-9\" id=\"user-content-fnref-9\" data-footnote-ref aria-describedby=\"footnote-label\">4</a></sup> Its been reported\nby some users that when booting to USB, the USB drive is assigned device id\n<code>/dev/sda</code> and the hard drive to <code>/dev/sdb</code>. When rebooting without USB drive\n(boot to new encrypted linux drive partition), the hard drive is reassigned to\ndevice id <code>/dev/sda</code> which may invalidate the above <code>arch.conf</code> boot loader\nentry. In this case, the encrypted linux partition will not boot because the\nboot loader config <code>arch.conf</code> is configured to boot from <code>/dev/sdb</code>. In this\ncase you can reboot to USB again, and edit the options line in <code>arch.conf</code> to\nread <code>/dev/sdaX</code>. Replace X with your partition id.</p>\n<p>Check the boot tree with <code>tree /boot/</code> (If <code>tree</code> isn’t installed, install it\nwith <code>pacman -S tree</code>). It should look something like this:</p>\n<pre><code>/boot/\n├── EFI\n│   ├── APPLE\n│   │   └── EXTENSIONS\n│   │       └── Firmware.scap\n│   ├── Boot\n│   │   └── BOOTX64.EFI\n│   └── gummiboot\n│       └── gummibootx64.efi\n├── initramfs-linux-fallback.img\n├── initramfs-linux.img\n├── loader\n│   ├── entries\n│   │   └── arch.conf\n│   └── loader.conf\n└── vmlinuz-linux\n</code></pre>\n<p><strong>Note</strong>: At this point, you may want to enable suspend-to-disk (No power\nconsumption aka \"Hibernate\" mode). I've chosen not to enable this functionality,\nbut if you're interested, you can\n<a href=\"http://loicpefferkorn.net/2015/01/arch-linux-on-macbook-pro-retina-2014-with-dm-crypt-lvm-and-suspend-to-disk/#suspend-to-disk-uswsusp:385892e3ac2613dca78d22bd09dbae7d\">read about it here</a>.</p>\n<p>Now we can have the bootloader write the initramfs onto the boot partition using\n<code>bootctl</code>, part of the systemd-boot package.</p>\n<pre><code class=\"language-bash\">bootctl install\n</code></pre>\n<h3>Reboot into New Installation</h3>\n<p>Let’s leave the chroot environment we used for the install:</p>\n<pre><code>exit\n</code></pre>\n<p>You can umount and close the encrypted volume:</p>\n<pre><code class=\"language-bash\">umount -R /mnt\ncryptsetup close vgcrypt\n</code></pre>\n<p>It’s not a bad idea to just double check the encryption to make sure it opens\nand mounts properly:</p>\n<pre><code class=\"language-bash\">cryptsetup open /dev/sda5 vgcrypt\nmount /dev/mapper/vgcrypt /mnt\n</code></pre>\n<p>If all goes accordingly, you can unmount and close the encryption again. And\nfinally…</p>\n<pre><code class=\"language-bash\">reboot\n</code></pre>\n<p>On reboot you should be greeted with the boot menu. After selecting Arch (or\nwaiting for it to timeout), you should be prompted for your password to decrypt\nthe drive, and then it should boot into the console.</p>\n<h2>Configuring Arch</h2>\n<p>You should now be running Arch Linux! Lets customize it and make it more useful.</p>\n<h3>Install an Arch User Repository Package Manager</h3>\n<p>Now we're about to dive deep into customizing Arch Linux installation with the\nutilities and application we'll be using on a day-to-day basis. To facilitate\ninstalling packages from the wider Arch User Repository (AUR), we'll install a\nutility named <code>yaourt</code>. You can (of course) maintain AUR package installations\nmanually, but I like a helper to help me manage them. yaourt is like the\nHomebrew of Arch Linux. I use\n<a href=\"https://wiki.archlinux.org/index.php/Yaourt\">yaourt</a> because it’s easy to\ninstall, takes the same optional flags as <code>pacman</code>, and works well.</p>\n<p>You need to use the \"official\" and manual way of installing AUR packages to get\nyaourt installed. It also requires <code>package-query</code> from the AUR, so we’re going\nto install that first.</p>\n<p>Now we’re going to download the <code>package-query</code> AUR package, unarchive it, and\nuse pacman to build and install the package. This allows us to manage the\npackage as if it was installed with pacman, although we're manually installing\nit.</p>\n<pre><code class=\"language-bash\">$ cd ~\n$ curl -L -O https://aur.archlinux.org/cgit/aur.git/snapshot/package-query.tar.gz\n$ tar -xvzf package-query.tar.gz\n$ cd package-query\n</code></pre>\n<p>Within the packages' folder, we’re going to run the following to build it:</p>\n<pre><code class=\"language-bash\">$ makepkg -s\n</code></pre>\n<p>This will run as your regular user only asking you for your root password if\nnecessary. With the package made, we can install it via pacman:</p>\n<pre><code class=\"language-bash\"># pacman -U package-query-1.6.2-1-x86_64.pkg.tar.xz\n</code></pre>\n<p>Now we’ll do the same for yaourt:</p>\n<pre><code class=\"language-bash\">$ cd ~\n$ curl -L -O https://aur.archlinux.org/cgit/aur.git/snapshot/yaourt.tar.gz\n$ tar -xvzf yaourt.tar.gz\n$ cd yaourt\n$ makepkg -s\n# pacman -U yaourt-1.6-1-any.pkg.tar.xz\n</code></pre>\n<p>From now on you can use <code>pacman</code> and <code>yaourt</code> interchangeably… for the most\npart. <code>yaourt</code> will install Arch repository packages and AUR packages. <code>pacman</code>,\nthough, will continue to only install Arch repository packages.</p>\n<h3>Configure Sound</h3>\n<p>ALSA works out of the box with Macs so install it via:</p>\n<pre><code class=\"language-bash\"># pacman -S alsa-utils\n</code></pre>\n<p>Then use:</p>\n<pre><code class=\"language-bash\">alsamixer\n</code></pre>\n<p>to control the speakers. Make sure to disable channels for speakers you don't\nhave. Test your speakers with:</p>\n<pre><code class=\"language-bash\">speaker-test -c 2\n</code></pre>\n<p>where 2 is the number of speakers.</p>\n<h3>Install X and Video Drivers</h3>\n<p>As this is going to be a graphical interface, we need are graphics card up and\nrunning with the proper drivers. Luckily this machine uses Intel graphics, and\nIntel is pretty good about providing Linux (and sometimes open-source) drivers.</p>\n<p>For Macbookpro 7,1 (Mid-2010 or 8,2 (Early-2011):</p>\n<pre><code class=\"language-bash\"># pacman -S xf86-video-intel mesa-libgl libva-intel-driver libva\n</code></pre>\n<p>For Macbookpro 11,3\n(Late-2013)<sup><a href=\"#user-content-fn-8\" id=\"user-content-fnref-8\" data-footnote-ref aria-describedby=\"footnote-label\">5</a></sup></p>\n<pre><code class=\"language-bash\"># pacman -S nvidia mesa-libgl libva-intel-driver libva\n</code></pre>\n<p>The <code>-S</code> flag tells pacman to install the subsequent packages listed. (Again,\nyou can use yaourt if you’d like.) This will install the Intel video driver, the\nMesa OpenGL graphics library, and video acceleration API for Intel graphics\nchipsets. It'll likely ask you to install additional dependencies. Get all the\ndependencies!</p>\n<p>With the necessary drivers installed, we can get Xorg (or the X Window System)\ninstalled.</p>\n<pre><code class=\"language-bash\"># pacman -S xorg-server xorg-server-utils xorg-xinit xterm\n</code></pre>\n<p>I like to install the Xorg utilities, too, because there are at least a couple\nI'll use later (either in this guide or another) that are helpful in improving\nHiDPI support for the MacBook’s HiDPI Retina display.</p>\n<h3>Some GUI Applications</h3>\n<p>Next we'll install a browser. This will install some typeface dependencies and\nfont- rendering libraries that we'll be tweaking later.</p>\n<pre><code class=\"language-bash\"># pacman -S firefox\n</code></pre>\n<h3>Improved Typography</h3>\n<p><strong>Update<sup><a href=\"#user-content-fn-10\" id=\"user-content-fnref-10\" data-footnote-ref aria-describedby=\"footnote-label\">6</a></sup></strong></p>\n<p><strong>It appears\n<a href=\"https://github.com/bohoomil/fontconfig-ultimate/issues/191\">the package maintainer for Infinality has gone dark</a></strong>.\nSkip this section and <a href=\"#window-manager-awesome\">continue to the next</a> until\nthere is a solution for better typography on the linux desktop.</p>\n<p>If you use the web and appreciate typography, you'll want to install a set of\ndecent fonts.</p>\n<p>Infinality is a package group that has been meticulously crafted from the\nground-up to provide beautifully rendered typography to the Linux platform. The\npackage maintainer spent a ton of time tearing down the existing font stack, and\ncarefully rebuilding it to provide fast-rendering fonts that more faithfully\npresent the typography than either Windows, OS X or Ubuntu systems. It also\nprovides a set of preset-configurations that allow the user to switch to a\nWindows-like or OS X-like configuration. I highly recommend\n<a href=\"http://bohoomil.com/doc/\">reading the documentation</a> if you'd like to know more\nabout typography rendering on GNU/Linux.</p>\n<p>First add the following package repositories to <code>/etc/pacman.conf</code>.</p>\n<pre><code>[infinality-bundle]\nServer = http://bohoomil.com/repo/$arch\n[infinality-bundle-fonts]\nServer = http://bohoomil.com/repo/fonts\n</code></pre>\n<p>Next we'll add the\n<a href=\"https://bbs.archlinux.org/viewtopic.php?id=162098\">package maintainers PGP key</a>\nto the package database, update the package database and install the packages.</p>\n<pre><code class=\"language-bash\"># pacman-key -r 962DDE58\n# pacman-key --lsign-key 962DDE58\n# pacman -Syyu\n# pacman -S infinality-bundle\n# pacman -S infinality-bundle-fonts\n</code></pre>\n<p>Make sure to select the option <code>fontconfig-infinality-ultimate</code> as that\nconfiguration\n<a href=\"http://bohoomil.com/doc/01-overview/\">is the most clean, efficient and looks the best out of the box</a>.\nThe installation may ask to use the Infinality packages in place of the\ndependencies installed by Firefox. Choose the Infinality packages.</p>\n<p>To enable selection of predefined font substitution styles and antialiasing\nsettings, apart from the rendering settings of the engine itself. After doing\nso, you can select the font style (win7, winxp, osx, linux, ...) with:</p>\n<pre><code class=\"language-bash\"># fc-presets set\n</code></pre>\n<h3>Window Manager Awesome</h3>\n<p>Awesome is a tiling window manager for the user that prefers keyboard commands\nto mouse or touchpad, and treats window chrome as needless ornamentation. Your\napplication content is king, and efficiency is the goal. Its quick and light.\nLets install the window manager (WM), awesome.</p>\n<p>To install:</p>\n<pre><code class=\"language-bash\"># pacman -S awesome\n</code></pre>\n<p>Added this<sup><a href=\"#user-content-fn-5\" id=\"user-content-fnref-5\" data-footnote-ref aria-describedby=\"footnote-label\">7</a></sup> to run <code>awesome</code>\nwhen x starts:</p>\n<pre><code>echo exec awesome > .xinitrc\n</code></pre>\n<h3>Touchpad Support</h3>\n<p>You’ll probably want to use your MacBook’s touchpad when you have a GUI. The\nsimplest driver is the synaptics driver:</p>\n<pre><code class=\"language-bash\"># pacman -S xf86-input-synaptics\n</code></pre>\n<p>The following config at /usr/share/X11/xorg.conf.d/70-synaptics.conf works well\nfor me, it uses the same \"Natural Motion\" that OS X does. Copy that file to the\nfollowing location <code>/etc/X11/xorg.conf.d/70-synaptics.conf</code> and add the options\nbetween the <code>START</code> and <code>END</code> comments.</p>\n<pre><code>Section \"InputClass\"\n    MatchIsTouchpad \"on\"\n    Identifier      \"touchpad catchall\"\n    Driver          \"synaptics\"\n\n    # START: Add these options\n    # 1 = left, 2 = right, 3 = middle\n    Option          \"TapButton1\" \"1\"\n    Option          \"TapButton2\" \"3\"\n    Option          \"TapButton3\" \"2\"\n    # Palm detection\n    Option          \"PalmDetect\" \"1\"\n    # Horizontal scrolling\n    Option \"HorizTwoFingerScroll\" \"1\"\n    Option \"VertTwoFingerScroll\" \"on\"\n    # Natural Scrolling (and speed)\n    Option \"VertScrollDelta\" \"-450\"\n    Option \"HorizScrollDelta\" \"-450\"\n    # END\nEndSection\n</code></pre>\n<h3>Configuring Wireless</h3>\n<p>Before rebooting into our lovely new GUI, let's get wireless setup to work when\nwe reboot.</p>\n<p>This particular machine has the Broadcom BCM4360 wireless chipset. Broadcom has\nbeen pretty mixed in the FLOSS support it seems. The BCM4360 is not supported by\nthe kernel itself, so we’ll need to use Broadcom’s non-free, non-open driver:\n<code>broadcom-wl</code>. I actually don’t think this even officially supports the BCM4360\nchipset, but it works well enough. We’ll need to install the AUR package:</p>\n<pre><code class=\"language-bash\">$ yaourt -S broadcom-wl dialog wpa_supplicant\n</code></pre>\n<p>And activate the kernel module:</p>\n<pre><code class=\"language-bash\"># modprobe wl\n</code></pre>\n<p><strong>Note</strong>: If you update to a newer kernel in the future, you may need to\nuninstall and reinstall the <code>broadcom-wl</code> package so it updates with the new\nlinux-header.</p>\n<p>We need to stop the dhcpcd service we were using for the ethernet and start the\n<code>wifi-menu</code><sup><a href=\"#user-content-fn-1\" id=\"user-content-fnref-1-2\" data-footnote-ref aria-describedby=\"footnote-label\">1</a></sup> utility.\nKeeping both running can cause conflicts.</p>\n<pre><code class=\"language-bash\"># systemctl disable dhcpcd.service\n# wifi-menu\n</code></pre>\n<p>This will create and enable a systemd service that will start when the computer\nboots. Changes to the profile file will not propagate to the service file\nautomatically. After such changes, it is necessary to reenable the profile:</p>\n<pre><code class=\"language-bash\"># netctl reenable PROFILE\n</code></pre>\n<p>After enabling a profile, it will be started at next boot.</p>\n<p>Finally, if you find your wireless is dropping connections, you may find turning\noff Wi-Fi power management. Simply create this as an executable ( chmod +x\n<code>/etc/pm/wireless</code> and add the following contents:</p>\n<pre><code>#!/bin/sh\niwconfig wlp2s0 power off\n</code></pre>\n<h3>Done!</h3>\n<p>Now when you reboot, you should be all set to go start customizing to your\nheart’s content, adding applications as you’d like, and playing around with your\nnew Arch Linux box with Awesome.s</p>\n<h2>Fine Tuning</h2>\n<p>Power settings took quite a bit of tweaking. Without these setting, the laptop\nran very hot, and drained battery life very fast. I would recommend following\nthese steps to improve battery life. There still may be room for improvement,\nthough.</p>\n<p>One more thing: If you search \"MacBook Pro and Arch Linux\" you’ll probably read\nsome things about disabling ACPI interrupts that were causing overheating and\nhigh CPU usage. If you have updated to the latest version of OS X 10.10\n\"Yosemite\" then you should be OK to skip.</p>\n<h3>Display Color Profile</h3>\n<p>I noticed that colors seemed washed-out in Arch Linux, so this task will attempt\nto color-correct the display. Luckily a utility <code>xcalib</code> exists that can load\ncolor profiles from OS X as X options. This should give you true color-parity\nbetween operating systems.</p>\n<p>First, boot into OS X and copy the color profiles located in\n<code>/Library/ColorSync/Profiles/Displays</code> to somewhere so you can boot into\nGNU/Linux and copy them into your home directory. I created a directory named\n<code>~/.colorprofiles</code> for these files.</p>\n<p>Second, install the <code>xcalib</code> package from the Arch AUR.</p>\n<pre><code class=\"language-bash\">yaourt -S xcalib\n</code></pre>\n<p>Finally you can activate it by running:</p>\n<pre><code class=\"language-bash\">xcalib ~/.colorprofiles/FILENAME.icc\n</code></pre>\n<p>Where <code>FILENAME</code> is the path to your color profile file.</p>\n<p>To load this color profile when X starts, I also added this command to the\n<code>.xinitrc</code> file in my home directory. Just make sure you replace <code>FILENAME</code> with\nthe name of your color-profile <code>.icc</code> file exported from OS X.</p>\n<pre><code class=\"language-bash\">if [ `type -P xcalib` ]; then\n  # Use the color profile\n  xcalib ~/.colorprofiles/FILENAME.icc\nfi;\n</code></pre>\n<h3>Display Color Correction</h3>\n<p>If you spend as many hours looking at the display as I do, you'll quickly\nappreciate a display that adapts its colors to the time of day.\n<a href=\"https://justgetflux.com\">F.lux</a> adjusts monitor color temperature adaptively to\nease eye strain.</p>\n<pre><code class=\"language-bash\">yaourt -S xfluxd\n</code></pre>\n<p>Then edit <code>/etc/xfluxd.conf</code> to set your rough lat/long coordinates (in decimal\nformat) in order to correctly shift the color correction with the sunrise and\nsunset.</p>\n<p>Finally, enable and start the <code>xfluxd</code> service. <strong>Note</strong> you should run this as\nyour normal user, not as root.</p>\n<pre><code class=\"language-bash\">systemctl enable --user xfluxd\nsystemctl start --user xfluxd\n</code></pre>\n<h3>Power Management</h3>\n<p>The power management from Arch out of the box is not very good. There are a few\ngood tools out there, but <code>PowerTOP</code> is nice because of its benchmarking\nutilities<sup><a href=\"#user-content-fn-2\" id=\"user-content-fnref-2\" data-footnote-ref aria-describedby=\"footnote-label\">8</a></sup>.</p>\n<blockquote>\n<p>PowerTOP is a tool provided by Intel to enable various powersaving modes in\nuserspace, kernel and hardware. It is possible to monitor processes and show\nwhich of them are utilizing the CPU and wake it from its Idle-States, allowing\nyou to identify applications with particular high power demands.</p>\n</blockquote>\n<pre><code class=\"language-bash\">yaourt -S powertop\n</code></pre>\n<p>You may want to put your laptop on battery power and calibrate powertop:</p>\n<pre><code class=\"language-bash\"># powertop --calibrate\n</code></pre>\n<p>That’ll cause the screen to blackout from time to time. Just let it run. It\ntakes a few minutes then your screen will come back on.</p>\n<p>You can create a systemd service that will launch powertop's autotune settings\non startup.</p>\n<pre><code># /etc/systemd/system/powertop.service\n\n[Unit]\nDescription=Powertop tunings\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/powertop --auto-tune\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>\n<p>And enable it to automatically start at boot time, then start it for your\ncurrent boot session.</p>\n<pre><code class=\"language-bash\"># systemctl enable powertop.service\n# systemctl start powertop.service\n</code></pre>\n<h3>Laptop Mode Tools</h3>\n<p>Laptop Mode Tools<sup><a href=\"#user-content-fn-6\" id=\"user-content-fnref-6\" data-footnote-ref aria-describedby=\"footnote-label\">9</a></sup> is a\nlaptop power saving package for Linux systems. It is the primary way to enable\nthe Laptop Mode feature of the Linux kernel, which allows you to tweak a number\nof other power-related settings using a simple configuration file. Combined with\n<code>acpid</code> and CPU frequency scaling, LMT provides a complete notebook power\nmanagement suite.</p>\n<pre><code class=\"language-bash\">$ yaourt -S laptop-mode-tools\n</code></pre>\n<p>If you want to enable laptop mode even on AC power, because you run the laptop\nattached to an external keyboard and monitor, edit:</p>\n<pre><code># /etc/laptop-mode/laptop-mode.conf`:\n...\nENABLE_LAPTOP_MODE_ON_AC=1\n...\nENABLE_LAPTOP_MODE_WHEN_LID_CLOSED=1\n</code></pre>\n<p>We're going to disable LMT from handling CPU frequency scaling since we've setup\n<code>cpupower</code> to handle that:</p>\n<pre><code># /etc/laptop-mode/conf.d/cpufreq.conf\n...\n# CONTROL_CPU_FREQUENCY=\"AUTO\"\nCONTROL_CPU_FREQUENCY=0\n</code></pre>\n<p>and disable Intel pstate handling as well:</p>\n<pre><code># /etc/laptop-mode/conf.d/intel_pstate.conf\n# CONTROL_INTEL_PSTATE=\"auto\"\nCONTROL_INTEL_PSTATE=0\n</code></pre>\n<p>Finally, enable and start the systemd service:</p>\n<pre><code class=\"language-bash\"># systemctl enable laptop-mode.service\n# systemctl start  laptop-mode.service\n</code></pre>\n<h3>acpid</h3>\n<p>A very useful tool is from the <code>acpi</code> package, which provides battery\ninformation using the command <code>acpi -v</code>. To install:</p>\n<pre><code class=\"language-bash\"># pacman -S acpi\n</code></pre>\n<p><code>acpid</code> is an extensible daemon for handling ACPI events. It can run commands\nwhen the laptop lid is closed, etc.</p>\n<pre><code class=\"language-bash\"># pacman -S acpid\n# systemctl enable acpid.service\n# systemctl start  acpid.service\n</code></pre>\n<h3>CPU Frequency Scaling</h3>\n<p>Another utility that will help with CPU frequency scaling is <code>cpupower</code>, it\nprovides useful CLI utilities and a systemd service to change the CPU governor\nat boot.</p>\n<pre><code class=\"language-bash\">$ yaourt -S cpupower\n# systemctl enable cpupower\n# systemctl start cpupower\n</code></pre>\n<p>I use cpupower to modulate the CPU’s speeds. This keeps CPU in check from maxing\nout at all times. My cpupower config file at <code>/etc/default/cpupower</code> has the\nfollowing line changed:</p>\n<pre><code>governor='powersave'\n</code></pre>\n<p>You should adjust this setting to your own needs.</p>\n<h3>Temperature Management</h3>\n<p>Intel provides a daemon that will keep tabs on the CPUs’ temperature and adjust\nsettings to keep it from getting too hot, its called <code>thermald</code>.</p>\n<pre><code class=\"language-bash\">$ yaourt -S thermald\n# systemctl enable thermald.service\n# systemctl start thermald.service\n</code></pre>\n<h3>Fan Control</h3>\n<p>Finally, the kernel doesn’t seem to have very fine control over the MacBook’s\nfan. The following script helps add fine-tuning for the fan that will increase\nits baseline speed and ramp it up gently, so it’s not an all-or-nothing kind of\nsetup.</p>\n<pre><code class=\"language-bash\">$ yaourt -S mbpfan-git\n# systemctl enable mbpfan.service\n# systemctl start mbpfan.service\n</code></pre>\n<p>By default the service runs in verbose mode which adds tons of output to the\nsystem journal. It basically works by measuring the CPU temp, adjusting the fan\nspeed accordingly, and then sleeping for a given number of seconds. With verbose\nmode on, it logs its wakeup every few seconds. That means a lot of writing to\nthe journal. So I changed the service under\n<code>/usr/lib/systemd/system/mbpfan.service</code> so the following line reads like so:</p>\n<pre><code>ExecStart=/usr/sbin/mbpfan -f\n</code></pre>\n<h3>Apple Keyboard</h3>\n<p>To get the <code>fn</code> keys working in X, we will install <code>xbindkeys</code> which helps bind\nkeyboard keys to commands. We will bind keys for volume, keyboard and display\nbrightness.</p>\n<pre><code>```bash\n# pacman -S xbindkeys\nyaourt -S xorg-xbacklight kbdlight\n```\n</code></pre>\n<p>Create your configuration file for xbindkeys: <code>.xbindkeysrc</code></p>\n<pre><code># Increase volume 5% with Apple volume up\n\"amixer set Master playback 5%+\"\n    m:0x0 + c:123\n    XF86AudioRaiseVolume\n# Increase volume 5% with F12\n\"amixer set Master playback 5%+\"\n    m:0x0 + c:96\n\n\n# Decrease volume 5% with Apple volume down\n\"amixer set Master playback 5%-\"\n    m:0x0 + c:122\n    XF86AudioLowerVolume\n# Decrease volume 5% with F11\n\"amixer set Master playback 5%-\"\n    m:0x0 + c:95\n\n\n# Mute with Apple mute\n\"amixer set Master toggle\"\n    m:0x0 + c:121\n    XF86AudioMute\n# Mute with F10\n\"amixer set Master toggle\"\n    m:0x0 + c:76\n\n\n# Suspend system\n\"systemctl suspend\"\n    m:0x0 + Mod4 + c:107\n    Mod4 + XF86Eject\n\n\n# Dim keyboard\n\"kbdlight down\"\n    m:0x0 + c:237\n    XF86KbdBrightnessUp\n\n\n# Brighten keyboard\n\"kbdlight up\"\n    m:0x0 + c:238\n    XF86KbdBrightnessDown\n</code></pre>\n<p>Next we'll auto-start xbindkeys when X starts, add this to your <code>.xinitrc</code> file:</p>\n<pre><code class=\"language-bash\">if [ `type -P xbindkeys` ]; then\n  # Load custom keyboard key bindings\n  xbindkeys\nfi;\n</code></pre>\n<h3>Apple Trackpad</h3>\n<p>Finally<sup><a href=\"#user-content-fn-3\" id=\"user-content-fnref-3\" data-footnote-ref aria-describedby=\"footnote-label\">10</a></sup>, we'll setup a\nBluetooth Apple Trackpad. To do this, we'll install some bluetooth core\nutilities</p>\n<pre><code class=\"language-bash\"># pacman -S bluez bluez-utils\n# modprobe btusb  # Make sure bluetooth kernel module is loaded\n# systemctl enable bluetooth.service  # Start bluetooth on reboot\n# systemctl start bluetooth.service\n</code></pre>\n<p>To actually connect to the Trackpad, we'll use the <code>bluetoothctl</code> interactive\nutility to scan-for, discover, pair and connect to the Trackpad. (If your\nTrackpad is already paired with another device, make sure to turn it off, then\nlong-hold the power button until the LED flashes.)</p>\n<pre><code>$ bluetoothctl\n> power on\n> scan on\n> agent on\n> devices    # You should see the MAC address of your Trackpad appear if its in discoverable mode\n> pair mac 28:37:37:2B:42:7A\n> connect 28:37:37:2B:42:7A\n</code></pre>\n<p>Then we'll setup some <code>udev</code> rules so USB Bluetooth is activated and loade when\nthe system boots up.</p>\n<pre><code># /etc/udev/rules.d/10-local.rules\n# Set bluetooth power up\nACTION==\"add\", KERNEL==\"hci0\", RUN+=\"/usr/bin/hciconfig hci0 up\"\n</code></pre>\n<h2>Conclusion</h2>\n<p>Wrapping up, I have nothing to add other than what you do with your system is up\nto you.</p>\n<h2>References</h2>\n<p>The following articles were very useful in providing some help and inspiration.</p>\n<ul>\n<li><a href=\"https://mchladek.me/post/arch-mbp/\">Installing Arch Linux on a MacBook Pro - Michael Chladek</a></li>\n<li><a href=\"http://zanshin.net/2015/02/05/arch-linux-on-a-macbook-pro-part-1-creating-a-usb-installer/\">Introductory MacBook Arch Guide - Zanshin</a></li>\n<li><a href=\"http://loicpefferkorn.net/2015/01/arch-linux-on-macbook-pro-retina-2014-with-dm-crypt-lvm-and-suspend-to-disk/\">Arch Linux on MacBook Pro Retina 2014 with DM-Crypt, LVM and suspend to disk - Loïc Pefferkorn</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/MacBook\">ArchWiki MacBook</a></li>\n<li><a href=\"https://wiki.archlinux.org/index.php/MacBookPro11,x\">ArchWiki MacBookPro11,x</a></li>\n<li><a href=\"https://medium.com/@philpl/arch-linux-running-on-my-macbook-2ea525ebefe3#.ai90cnihe\">Arch Linux Running on my MacBook - Phil Plückthun</a></li>\n<li>\n<cite id=\"cite:1\">\n<a href=\"https://www.youtube.com/watch?v=Fzmm87oVQ6c\">My personal fight\n  against the modern laptop</a>\nA talk discussing our decreasing ability to change our hardware to suit\nour needs.\n<a class=\"RefBack\" href=\"#ref:cite:1\"></a>\n</cite>\n</li>\n</ul>\n<p>Any changes to this article will be annotated with a footnote and explained\nhere.</p>\n<section data-footnotes class=\"footnotes\"><h2 id=\"footnote-label\" class=\"sr-only\">Footnotes</h2>\n<ol>\n<li id=\"user-content-fn-1\">\n<p>March 6, 2016: Previously used <code>NetworkManager</code> to detect\nand connect to WiFi networks, but have changed to use\n<code>netctl</code> and <code>wifi-menu</code> as these commands are\nmore low-level and have fewer dependencies. <a href=\"#user-content-fnref-1\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a> <a href=\"#user-content-fnref-1-2\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩<sup>2</sup></a></p>\n</li>\n<li id=\"user-content-fn-4\">\n<p>March 14, 2016: Thanks\n<a href=\"https://www.reddit.com/r/archlinux/comments/493k4n/installing_encrypted_arch_linux_on_an_apple/d0y36h4?context=3\">Fr0gm4n</a>\nfor suggestions simplifying the writing of <code>iso</code>\nimages to USB. <a href=\"#user-content-fnref-4\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-7\">\n<p>April 2, 2016: Thanks\n<a href=\"https://www.reddit.com/r/archlinux/comments/493k4n/installing_encrypted_arch_linux_on_an_apple/d1mleow?context=3\">Perceptes</a>\nfor helping to clarify the text explaining how to configure the bootloader. <a href=\"#user-content-fnref-7\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-9\">\n<p>December 2, 2016: Thanks to Joshua Brown for clarifications to writing the bootloader line. <a href=\"#user-content-fnref-9\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-8\">\n<p>July 28, 2016: Updated to support Macbookpro 11,3 devices with NVidia cards. This device uses NVIDIA GeForce GT 750M (Codename NVE7/GK107). <a href=\"#user-content-fnref-8\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-10\">\n<p>February 6, 2017: If anyone has a solution to the loss of Infinality bundle\ntypography, please drop me a line. <a href=\"#user-content-fnref-10\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-5\">\n<p>March 18, 2016: Changed references to <code>.Xinitrc</code> to the\ncorrect filename, <code>.xinitrc</code>. <a href=\"#user-content-fnref-5\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-2\">\n<p>March 8, 2016: Previously omitted the <code>-S</code> option in\nyaourt, fixed. <a href=\"#user-content-fnref-2\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-6\">\n<p>March 24, 2016: Added two new sections documenting Laptop Mode Tools\nand <code>acpid</code>. <a href=\"#user-content-fnref-6\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n<li id=\"user-content-fn-3\">\n<p>March 8, 2016: Added a section covering the Apple Trackpad. <a href=\"#user-content-fnref-3\" data-footnote-backref class=\"data-footnote-backref\" aria-label=\"Back to content\">↩</a></p>\n</li>\n</ol>\n</section>\n","slug":"2016-03-05-install-encrypted-arch-linux-on-apple-macbook-pro"}},"__N_SSG":true}